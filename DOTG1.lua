--[[
                                                                                                                                         
                                                                                                                                         
DDDDDDDDDDDDD             OOOOOOOOO     TTTTTTTTTTTTTTTTTTTTTTT       GGGGGGGGGGGGG  1111111                                             
D::::::::::::DDD        OO:::::::::OO   T:::::::::::::::::::::T    GGG::::::::::::G 1::::::1                                             
D:::::::::::::::DD    OO:::::::::::::OO T:::::::::::::::::::::T  GG:::::::::::::::G1:::::::1                                             
DDD:::::DDDDD:::::D  O:::::::OOO:::::::OT:::::TT:::::::TT:::::T G:::::GGGGGGGG::::G111:::::1                                             
  D:::::D    D:::::D O::::::O   O::::::OTTTTTT  T:::::T  TTTTTTG:::::G       GGGGGG   1::::1                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G                 1::::1                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G                 1::::1                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G    GGGGGGGGGG   1::::l                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G    G::::::::G   1::::l                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G    GGGGG::::G   1::::l                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G        G::::G   1::::l                                             
  D:::::D    D:::::D O::::::O   O::::::O        T:::::T        G:::::G       G::::G   1::::l                                             
DDD:::::DDDDD:::::D  O:::::::OOO:::::::O      TT:::::::TT       G:::::GGGGGGGG::::G111::::::111                                          
D:::::::::::::::DD    OO:::::::::::::OO       T:::::::::T        GG:::::::::::::::G1::::::::::1                                          
D::::::::::::DDD        OO:::::::::OO         T:::::::::T          GGG::::::GGG:::G1::::::::::1                                          
DDDDDDDDDDDDD             OOOOOOOOO           TTTTTTTTTTT             GGGGGG   GGGG111111111111                                          
                                                                                                                                         
                                                                                                                                                                                                                                                                                
                                                                                                                                         
DDDDDDDDDDDDD                               ffffffffffffffff                                                                             
D::::::::::::DDD                           f::::::::::::::::f                                                                            
D:::::::::::::::DD                        f::::::::::::::::::f                                                                           
DDD:::::DDDDD:::::D                       f::::::fffffff:::::f                                                                           
  D:::::D    D:::::D     eeeeeeeeeeee     f:::::f       ffffffeeeeeeeeeeee    nnnn  nnnnnnnn        ssssssssss       eeeeeeeeeeee        
  D:::::D     D:::::D  ee::::::::::::ee   f:::::f           ee::::::::::::ee  n:::nn::::::::nn    ss::::::::::s    ee::::::::::::ee      
  D:::::D     D:::::D e::::::eeeee:::::eef:::::::ffffff    e::::::eeeee:::::een::::::::::::::nn ss:::::::::::::s  e::::::eeeee:::::ee    
  D:::::D     D:::::De::::::e     e:::::ef::::::::::::f   e::::::e     e:::::enn:::::::::::::::ns::::::ssss:::::se::::::e     e:::::e    
  D:::::D     D:::::De:::::::eeeee::::::ef::::::::::::f   e:::::::eeeee::::::e  n:::::nnnn:::::n s:::::s  ssssss e:::::::eeeee::::::e    
  D:::::D     D:::::De:::::::::::::::::e f:::::::ffffff   e:::::::::::::::::e   n::::n    n::::n   s::::::s      e:::::::::::::::::e     
  D:::::D     D:::::De::::::eeeeeeeeeee   f:::::f         e::::::eeeeeeeeeee    n::::n    n::::n      s::::::s   e::::::eeeeeeeeeee      
  D:::::D    D:::::D e:::::::e            f:::::f         e:::::::e             n::::n    n::::nssssss   s:::::s e:::::::e               
DDD:::::DDDDD:::::D  e::::::::e          f:::::::f        e::::::::e            n::::n    n::::ns:::::ssss::::::se::::::::e              
D:::::::::::::::DD    e::::::::eeeeeeee  f:::::::f         e::::::::eeeeeeee    n::::n    n::::ns::::::::::::::s  e::::::::eeeeeeee      
D::::::::::::DDD       ee:::::::::::::e  f:::::::f          ee:::::::::::::e    n::::n    n::::n s:::::::::::ss    ee:::::::::::::e      
DDDDDDDDDDDDD            eeeeeeeeeeeeee  fffffffff            eeeeeeeeeeeeee    nnnnnn    nnnnnn  sssssssssss        eeeeeeeeeeeeee                                                                                                                                  
                                                                                                                                         
                                                                                                                                         
     OOOOOOOOO        ffffffffffffffff       TTTTTTTTTTTTTTTTTTTTTTThhhhhhh                                                              
   OO:::::::::OO     f::::::::::::::::f      T:::::::::::::::::::::Th:::::h                                                              
 OO:::::::::::::OO  f::::::::::::::::::f     T:::::::::::::::::::::Th:::::h                                                              
O:::::::OOO:::::::O f::::::fffffff:::::f     T:::::TT:::::::TT:::::Th:::::h                                                              
O::::::O   O::::::O f:::::f       ffffff     TTTTTT  T:::::T  TTTTTT h::::h hhhhh           eeeeeeeeeeee                                 
O:::::O     O:::::O f:::::f                          T:::::T         h::::hh:::::hhh      ee::::::::::::ee                               
O:::::O     O:::::Of:::::::ffffff                    T:::::T         h::::::::::::::hh   e::::::eeeee:::::ee                             
O:::::O     O:::::Of::::::::::::f                    T:::::T         h:::::::hhh::::::h e::::::e     e:::::e                             
O:::::O     O:::::Of::::::::::::f                    T:::::T         h::::::h   h::::::he:::::::eeeee::::::e                             
O:::::O     O:::::Of:::::::ffffff                    T:::::T         h:::::h     h:::::he:::::::::::::::::e                              
O:::::O     O:::::O f:::::f                          T:::::T         h:::::h     h:::::he::::::eeeeeeeeeee                               
O::::::O   O::::::O f:::::f                          T:::::T         h:::::h     h:::::he:::::::e                                        
O:::::::OOO:::::::Of:::::::f                       TT:::::::TT       h:::::h     h:::::he::::::::e                                       
 OO:::::::::::::OO f:::::::f                       T:::::::::T       h:::::h     h:::::h e::::::::eeeeeeee                               
   OO:::::::::OO   f:::::::f                       T:::::::::T       h:::::h     h:::::h  ee:::::::::::::e                               
     OOOOOOOOO     fffffffff                       TTTTTTTTTTT       hhhhhhh     hhhhhhh    eeeeeeeeeeeeee                               
                                                                                                                                         
                                                                                                                                                                                                                                                                        
        GGGGGGGGGGGGGhhhhhhh                                          tttt               tttt                                  1111111   
     GGG::::::::::::Gh:::::h                                       ttt:::t            ttt:::t                                 1::::::1   
   GG:::::::::::::::Gh:::::h                                       t:::::t            t:::::t                                1:::::::1   
  G:::::GGGGGGGG::::Gh:::::h                                       t:::::t            t:::::t                                111:::::1   
 G:::::G       GGGGGG h::::h hhhhh           eeeeeeeeeeee    ttttttt:::::tttttttttttttt:::::ttttttt       ooooooooooo           1::::1   
G:::::G               h::::hh:::::hhh      ee::::::::::::ee  t:::::::::::::::::tt:::::::::::::::::t     oo:::::::::::oo         1::::1   
G:::::G               h::::::::::::::hh   e::::::eeeee:::::eet:::::::::::::::::tt:::::::::::::::::t    o:::::::::::::::o        1::::1   
G:::::G    GGGGGGGGGG h:::::::hhh::::::h e::::::e     e:::::etttttt:::::::tttttttttttt:::::::tttttt    o:::::ooooo:::::o        1::::l   
G:::::G    G::::::::G h::::::h   h::::::he:::::::eeeee::::::e      t:::::t            t:::::t          o::::o     o::::o        1::::l   
G:::::G    GGGGG::::G h:::::h     h:::::he:::::::::::::::::e       t:::::t            t:::::t          o::::o     o::::o        1::::l   
G:::::G        G::::G h:::::h     h:::::he::::::eeeeeeeeeee        t:::::t            t:::::t          o::::o     o::::o        1::::l   
 G:::::G       G::::G h:::::h     h:::::he:::::::e                 t:::::t    tttttt  t:::::t    tttttto::::o     o::::o        1::::l   
  G:::::GGGGGGGG::::G h:::::h     h:::::he::::::::e                t::::::tttt:::::t  t::::::tttt:::::to:::::ooooo:::::o     111::::::111
   GG:::::::::::::::G h:::::h     h:::::h e::::::::eeeeeeee        tt::::::::::::::t  tt::::::::::::::to:::::::::::::::o     1::::::::::1
     GGG::::::GGG:::G h:::::h     h:::::h  ee:::::::::::::e          tt:::::::::::tt    tt:::::::::::tt oo:::::::::::oo      1::::::::::1
        GGGGGG   GGGG hhhhhhh     hhhhhhh    eeeeeeeeeeeeee            ttttttttttt        ttttttttttt     ooooooooooo        111111111111


    
        __                  __                    
       / /_  __  __   _____/ /_  ____ _____  ____ 
      / __ \/ / / /  / ___/ __ \/ __ `/ __ \/ __ \
     / /_/ / /_/ /  / /__/ / / / /_/ / /_/ / /_/ /
    /_.___/\__, /   \___/_/ /_/\__,_/ .___/\____/ 
          /____/                   /_/            

]]                                                                                                                                         
                                                                                                                                         
                                                                                                                                         
script_name('DOTG1 - Defence Of The Ghetto 1 (by chapo // vk.com/chaposcripts)')                                                                                                                               
script_author('chapo')                                                            
script_version('1')                                                                                                                     

require('lib.moonloader')
local ffi = require('ffi')
local imgui = require('mimgui')
local Vector3D = require('vector3d')
local encoding = require('encoding')
encoding.default = 'CP1251'
u8 = encoding.UTF8
--local ui = require('DOTG1.ui')
--local net = core.net

SIDE_GROOVE, SIDE_BALLAS = 0, 1
local __LIB_STATUS_map, map = pcall(require, 'DOTG1.map')                               assert(__LIB_STATUS_map, 'lib->DOTG1->map.lua not found!')
local __LIB_STATUS_camera, camera = pcall(require, 'DOTG1.camera')                      assert(__LIB_STATUS_camera, 'lib->DOTG1->camera.lua not found!')
local __LIB_STATUS_local_player, local_player = pcall(require, 'DOTG1.local_player')    assert(__LIB_STATUS_local_player, 'lib->DOTG1->local_player.lua not found!')
local __LIB_STATUS_hero, hero = pcall(require, 'DOTG1.hero')                            assert(__LIB_STATUS_hero, 'lib->DOTG1->hero.lua not found!')
local __LIB_STATUS_resource, resource = pcall(require, 'DOTG1.resource')                assert(__LIB_STATUS_resource, 'lib->DOTG1->resource.lua not found!')
local __LIB_STATUS_ui, ui = pcall(require, 'DOTG1.ui')                                  assert(__LIB_STATUS_ui, 'lib->DOTG1->ui.lua not found!')
local items = require('DOTG1.items')



GAME_STATE = { NONE = 0, MAIN_MENU = 1, HERO_SELECT = 2, IN_GAME = 3 }
PLAYER = {
    STATE = GAME_STATE.HERO_SELECT,
    hero = hero.list[1],
    camera_mode = 0,
    debuff = {}
}


--==[ INTERFACE ]==--
imgui.OnInitialize(function()
    imgui.GetIO().IniFilename = nil
    ui.init()
end)

local ui_frame = imgui.OnFrame(
    function() 
        return PLAYER.STATE ~= GAME_STATE.NONE
    end,
    function(self)
        self.HideCursor = PLAYER.STATE ~= GAME_STATE.MAIN_MENU and PLAYER.STATE ~= GAME_STATE.HERO_SELECT
        local DL = imgui.GetBackgroundDrawList()

        ui.draw_health_bars(DL)

        -->> Main menu
        if PLAYER.STATE == GAME_STATE.MAIN_MENU or PLAYER.STATE == GAME_STATE.HERO_SELECT then
            local size = imgui.ImVec2(getScreenResolution())
            imgui.SetNextWindowSize(size, imgui.Cond.Always)
            imgui.SetNextWindowPos(imgui.ImVec2(0, 0), imgui.Cond.Always, imgui.ImVec2(0, 0))
            if imgui.Begin('dotg1_main_menu', _, imgui.WindowFlags.NoDecoration) then
                
                imgui.SetCursorPosY(size.y / 5)
                imgui.PushFont(ui.font[40])
                imgui.CenterText('Defense Of The Ghetto')
                imgui.PopFont()
                imgui.SetCursorPosY(size.y / 5 + 30)
                imgui.CenterText('by chapo')

                if PLAYER.STATE == GAME_STATE.MAIN_MENU then
                    local PLAY_BUTTON_SIZE = imgui.ImVec2(size.x / 8, size.y / 13)
                    imgui.SetCursorPos(imgui.ImVec2(size.x - PLAY_BUTTON_SIZE.x - 25, size.y - PLAY_BUTTON_SIZE.y - 25))

                    imgui.PushFont(ui.font[20])
                    if imgui.Button('PLAY', PLAY_BUTTON_SIZE) then
                        PLAYER.STATE = GAME_STATE.HERO_SELECT
                    end
                    imgui.PopFont()
                else
                    --imgui.Separator()
                    imgui.SetCursorPosY(size.y / 5 + 50)
                    imgui.PushFont(ui.font[40])
                    imgui.CenterText('CHOOSE YOUR HERO')
                    imgui.PopFont()

                    local start_pos = imgui.ImVec2(size.x / 2 - ((size.x / 8) / 2) * #hero.list, size.y / 2 - (size.y / 3) / 2)
                    imgui.SetCursorPos(start_pos)
                    for index, _hero in ipairs(hero.list) do
                        if imgui.BeginChild('hero_select_'.._hero.name, imgui.ImVec2(size.x / 8, size.y / 3), true, imgui.WindowFlags.NoScrollbar + imgui.WindowFlags.NoScrollWithMouse) then
                            local image_size = imgui.ImVec2(size.x / 8 - 10, size.y / 3 - 10)
                            
                            imgui.SetCursorPos(imgui.ImVec2(5, 5))
                            imgui.InvisibleButton('hero_select_'.._hero.name..'_HOVER_ZONE', imgui.ImVec2(size.x / 8 - 10, size.y / 3 - 10))
                            if imgui.IsItemHovered() then
                                image_size = imgui.ImVec2(size.x / 8, size.y / 3)
                            end
                            imgui.SetCursorPos(imgui.IsItemHovered() and imgui.ImVec2(0, 0) or imgui.ImVec2(5, 5))
                            imgui.Image(ui.image.hero[1].icon, image_size)
                            if imgui.IsItemHovered() then
                                imgui.BeginTooltip()
                                imgui.Text(_hero.name)
                                imgui.EndTooltip()
                                
                            end
                            if imgui.IsMouseClicked(0) then
                                PLAYER.hero = hero.list[index]
                                PLAYER.STATE = GAME_STATE.IN_GAME
                                
                                local_player.max_health = PLAYER.hero.max_health
                                local_player.max_mana = PLAYER.hero.max_mana
                                local_player.health = PLAYER.hero.max_health
                                local_player.mana = PLAYER.hero.max_mana

                                setPlayerModel(Player, PLAYER.hero.model)
                                map.create_map()
                                map.set_hp(PLAYER_PED, local_player.get('max_health'))
                               
                                setCharCoordinates(PLAYER_PED, 154, 5, 601)
                                giveWeaponToChar(PLAYER_PED, PLAYER.hero.weapon, PLAYER.hero.weapon_ammo)
                                setCurrentCharWeapon(PLAYER_PED, PLAYER.hero.weapon)
                                camera.point_camera_to_player()
                            end
                            imgui.EndChild()
                        end  
                        if index < #hero.list then
                            imgui.SameLine()
                        end
                    end
                end
                imgui.End()
            end
        end

        -->> abilities
        if PLAYER.STATE == GAME_STATE.IN_GAME then
            local resX, resY = getScreenResolution()
            imgui.SetNextWindowSize(imgui.ImVec2(resX / 3, resY / 7), imgui.Cond.Always)
            imgui.SetNextWindowPos(imgui.ImVec2(resX / 2, resY - resY / 7), imgui.Cond.Always, imgui.ImVec2(0.5, 0))
            if imgui.Begin('dotg1_hud', _, imgui.WindowFlags.NoDecoration) then
                local size = imgui.GetWindowSize()
                local bar_size_x = size.x - 10 - size.y

                imgui.SetCursorPos(imgui.ImVec2(10, 10))
                if imgui.BeginChild('player_image', imgui.ImVec2(size.y - 20, size.y - 20), true, imgui.WindowFlags.NoScrollbar + imgui.WindowFlags.NoScrollWithMouse) then
                    imgui.SetCursorPos(imgui.ImVec2(0, 0))
                    imgui.Image(ui.image.hero[1].icon, imgui.ImVec2(size.y - 20, size.y - 20))
                    imgui.EndChild()
                end
                if imgui.IsItemClicked() then
                    camera.point_camera_to_player()
                end
                imgui.SameLine()
                for index, ability in ipairs(PLAYER.hero.abilities) do
                    if imgui.BeginChild('ability_'..tostring(index), imgui.ImVec2(size.y / 2, size.y / 2), true) then
                        imgui.TextWrapped(tostring(ability.name))

                        local cd = local_player.cooldown[index] + ability.cooldown - os.clock()
                        if cd >= 0 then
                            imgui.Text('CD: '..tostring(local_player.cooldown[index] + ability.cooldown - os.clock()))
                        end
                        imgui.EndChild()
                    end
                    if imgui.IsItemHovered() then
                        imgui.BeginTooltip()
                        imgui.Text(ability.name..'\n\n'..u8(ability.tooltip))
                        imgui.EndTooltip()
                    end
                    if index < #PLAYER.hero.abilities then
                        imgui.SameLine()
                    end
                end

                

                imgui.SetCursorPos(imgui.ImVec2(10 + size.y - 20 + 10, size.y / 1.6))

                imgui.PushStyleColor(imgui.Col.Text, imgui.ImVec4(0, 0, 0, 0))
                imgui.PushStyleColor(imgui.Col.PlotHistogram, imgui.ImVec4(0.64, 0.03, 0.03, 1))
                imgui.PushStyleColor(imgui.Col.FrameBg, imgui.ImVec4(0.22, 0.02, 0.02, 1))
                --imgui.SetCursorPosX(size.x / 2 - bar_size_x / 2)
                imgui.ProgressBar(math.floor(local_player.get('health') * 100 / local_player.get('max_health')) / 100, imgui.ImVec2(bar_size_x, 20))
                imgui.SameLine()
                imgui.PopStyleColor(3)
                imgui.CenterText(tostring(local_player.get('health')))
                imgui.SameLine(500)
                imgui.Text('+'..tostring(local_player.get('regen_health')))

                imgui.SetCursorPos(imgui.ImVec2(10 + size.y - 20 + 10, size.y / 1.6 + 25))
                imgui.PushStyleColor(imgui.Col.Text, imgui.ImVec4(0, 0, 0, 0))
                imgui.PushStyleColor(imgui.Col.PlotHistogram, imgui.ImVec4(0.11, 0.26, 1, 1))
                imgui.PushStyleColor(imgui.Col.FrameBg, imgui.ImVec4(0.08, 0.12, 0.33, 1))
                imgui.ProgressBar(math.floor(local_player.get('mana') * 100 / local_player.get('max_mana')) / 100, imgui.ImVec2(bar_size_x, 20))
                imgui.SameLine()
                imgui.PopStyleColor(3)
                imgui.CenterText(tostring(local_player.get('mana')))
                imgui.SameLine(500)
                imgui.Text('+'..tostring(local_player.get('regen_mana')))

                imgui.SetCursorPos(imgui.ImVec2(size.x - 10 - 40, 10))
                if imgui.Button('CAM', imgui.ImVec2(40, 20)) then
                    PLAYER.camera_mode = PLAYER.camera_mode == 0 and 1 or 0
                    if PLAYER.camera_mode == 0 then
                        camera.point_camera_to_player()
                    elseif PLAYER.camera_mode == 1 then
                        restoreCameraJumpcut()
                    end
                end

                imgui.End()
            end
        end
    end
)



-->> Event Handlers
addEventHandler('onScriptTerminate', function(scr, quit)
    if scr == thisScript() then
        map.destroy_map()
        if not quit then
            --core.log('[FATAL ERROR] Script terminated (quit = false). Reloading...')
            thisScript():reload()
        end
    end
end)

addEventHandler('onWindowMessage', function(msg, key)
    if PLAYER.STATE == GAME_STATE.IN_GAME and msg == 0x0100 and not sampIsChatInputActive() then
        if key == VK_Q then
            local_player.use_ability(PLAYER.hero.abilities[1], 1)
        elseif key == VK_W then
            local_player.use_ability(PLAYER.hero.abilities[2], 2)
        elseif key == VK_E then
            local_player.use_ability(PLAYER.hero.abilities[3], 3)
        end
    end
end)

local movement = {
    go_to_coords = false,
    go_to_coords_coords = Vector3D(0, 0, 0),
    circles = {},
    target_handle = 1,
    last_hit = 0
}



local tower_ai_test = function()
    lua_thread.create(function()
        while true do
            wait(1000)
            --wait(2500)
            for handle, tag in pairs(map.pool.bots) do
                if tag:find('tower_(.+)') then
                    local team = tag:match('tower_(.+)')
                    -- find target for tower
                    for target_ped, target_tag in pairs(map.pool.bots) do
                        local target_team = 'undefined'
                        if target_tag:find('(.+)_(.+)') then
                            local target_type, target_team = target_tag:match('(.+)_(.+)')
                            if target_type == 'creep' or target_type == 'player' then
                                if team ~= target_team or true then
                                    local pedX, pedY, pedZ = getCharCoordinates(handle)
                                    local targetX, targetY, targetZ = getCharCoordinates(target_ped)
                                    if getDistanceBetweenCoords3d(pedX, pedY, pedZ, targetX, targetY, targetZ) < 10 then
                                        local tower_s_x, tower_s_y = convert3DCoordsToScreen(pedX, pedY, pedZ)
                                        local target_s_x, target_s_y = convert3DCoordsToScreen(targetX, targetY, targetZ)
                                        renderDrawLine(tower_s_x, tower_s_y, target_s_x, target_s_y, 4, 0xCCff0000)
                                        local start = os.clock()
                                        local rocket = createObject(345, pedX, pedY, pedZ)
                                        setObjectCollision(rocket, false)
                                        table.insert(map.pool.objects, rocket)

                                        
                                        while start + 3 - os.clock() > 0 do
                                            wait(0) 
                                            if doesObjectExist(rocket) then
                                                
                                                local result, rocketX, rocketY, rocketZ = getObjectCoordinates(rocket)
                                                if result then
                                                    if getDistanceBetweenCoords3d(rocketX, rocketY, rocketZ, targetX, targetY, targetZ) < 0.5 then
                                                        deleteObject(rocket)
                                                        if target_ped == PLAYER_PED then
                                                            local_player.health = local_player.health - 50
                                                            sampAddChatMessage('damage deal', -1)
                                                        else 
                                                            map.set_hp(target_ped, getCharHealth(target_ped) - 50)
                                                        end
                                                    else
                                                        slideObject(rocket, targetX, targetY, targetZ, 0.1, 0.1, 0.1, false)
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end 
    end)
    
end

sp = function()
    --local no = createObject(11696, map.pos.x - 300 - 5, map.pos.y - 125, map.pos.z - 1)
    --table.insert(map.pool.objects, no)

    for i = 1, 8 do
        local no = createObject(17031, map.pos.x - 227, map.pos.y - 200 + 50 * i, map.pos.z - 1)
        setObjectScale(no, 1.5)
        table.insert(map.pool.objects, no)
    end
    for i = 1, 8 do
        local no = createObject(17031, map.pos.x + 227, map.pos.y - 200 + 50 * i, map.pos.z - 1)
        setObjectHeading(no, 180)
        setObjectScale(no, 1.5)
        table.insert(map.pool.objects, no)
    end
    for i = 1, 8 do
        local no = createObject(17031, map.pos.x - 200 + 50 * i, map.pos.y - 227, map.pos.z - 1)
        setObjectHeading(no, 90)
        setObjectScale(no, 1.5)
        table.insert(map.pool.objects, no)
    end
    for i = 1, 8 do
        local no = createObject(17031, map.pos.x - 200 + 50 * i, map.pos.y + 227, map.pos.z - 1)
        setObjectHeading(no, 270)
        setObjectScale(no, 1.5)
        table.insert(map.pool.objects, no)
    end

    local f = createObject(6965, map.pos.x, map.pos.y, map.pos.z + 1)
    table.insert(map.pool.objects, f)

    local f = createObject(9833, map.pos.x - 0.5, map.pos.y, map.pos.z + 9  )
    table.insert(map.pool.objects, f)

    local f = createObject(348, map.pos.x - 1.5, map.pos.y, map.pos.z + 15)
    setObjectRotation(f, 0, 270+45, 0)
    setObjectScale(f, 15)
    table.insert(map.pool.objects, f)

    local f = createObject(348, map.pos.x + 1.5, map.pos.y, map.pos.z + 15)
    setObjectRotation(f, 0, 270 + 45, 180)
    setObjectScale(f, 15)
    table.insert(map.pool.objects, f)
end 

-->> main zalupa
local go_game_process = false
function main()
    while not isSampAvailable() do wait(0) end
    sampRegisterChatCommand('manaref', function()
        items.use_item('mana_refill', true)
    end)
    -->> INIT
    map.init()
    camera.init()

    sampRegisterChatCommand('dota', function()
        PLAYER.STATE = GAME_STATE.MAIN_MENU
        camera.point_camera_to_player()
    end)
    sampRegisterChatCommand('map', function()
        lua_thread.create(function()
            map.create_map()
            --map.teleport_player_to_map()
            setCharCoordinates(PLAYER_PED, 154, 5, 601)
            wait(500)
            PLAYER.STATE = GAME_STATE.IN_GAME
            map.set_hp(PLAYER_PED, local_player.get('max_health'))
            giveWeaponToChar(PLAYER_PED, 8, 1)
            setCurrentCharWeapon(PLAYER_PED, 8)
        end)
    end)

    sampRegisterChatCommand('spawncreeps', function()
        map.spawn_creep_stack(SIDE_GROOVE, 3)
    end)
    sp()
    tower_ai_test()
    while true do
        wait(0)
        if PLAYER.STATE == GAME_STATE.IN_GAME then
            map.set_hp(PLAYER_PED, local_player.health)
            for handle, tag in pairs(map.pool.bots) do
                local curX, curY = getCursorPos()
                local x, y, z = getCharCoordinates(handle)
                local pedX, pedY = convert3DCoordsToScreen(x, y, z)
                
                
                if getDistanceBetweenCoords2d(curX, curY, pedX, pedY) < 50 then
                    drawShadow(3, x, y, z + 1, 0.0, 1, 1, 1, 0, 0) 
                    drawShadow(3, x, y, z + 1, 0.0, 1, 1, 1, 0, 0) 
                    drawShadow(3, x, y, z + 1, 0.0, 1, 1, 1, 0, 0) 
                    drawShadow(3, x, y, z + 1, 0.0, 1, 1, 1, 0, 0) 
                    
                    drawLightWithRange(x, y, z + 2, 255, 0, 0, 10)  -- 09E5
                    drawLightWithRange(x, y, z + 2, 255, 0, 0, 10)  -- 09E5
                    drawLightWithRange(x, y, z + 2, 255, 0, 0, 10)  -- 09E5
                    drawLightWithRange(x, y, z + 2, 255, 0, 0, 10)  -- 09E5
                end
            end

            map.draw_circle_on_target()
            local_player.loop()

            local curX, curY = getCursorPos()
            local resX, resY = getScreenResolution()
            showCursor(not isKeyDown(VK_MBUTTON))
            if PLAYER.camera_mode == 0 then
                camera.update_camera()
            end
            --map.bots_ai()
            if isKeyDown(VK_LMENU) then
                map.draw_building_circles()
            end
            
            -->> PED CONTROLS 
            do
                ---->> disable ped controls
                for i = 0, 20 do
                    if isButtonPressed(Player, i) then
                        setGameKeyState(i, 0)
                    end
                end

                ---->> ped movement (RMB)
                local curX, curY = getCursorPos()
                local resX, resY = getScreenResolution()
                local posX, posY, posZ = convertScreenCoordsToWorld3D(curX, curY, 700.0)
                local camX, camY, camZ = getActiveCameraCoordinates()-- camera.pos.x, camera.pos.y, camera.pos.z
                local result, colpoint = processLineOfSight(camX, camY, camZ, posX, posY, posZ, true, true, false, true, false, false, false)
                if result and colpoint.entity ~= 0 then
                    local normal = colpoint.normal
                    local pos = Vector3D(colpoint.pos[1], colpoint.pos[2], colpoint.pos[3]) - (Vector3D(normal[1], normal[2], normal[3]) * 0.1)
                    local zOffset = 300
                    if normal[3] >= 0.5 then zOffset = 1 end
                    local result, colpoint2 = processLineOfSight(pos.x, pos.y, pos.z + zOffset, pos.x, pos.y, pos.z - 0.3, true, true, false, true, false, false, false)
                    if result then
                        local pos = Vector3D(colpoint2.pos[1], colpoint2.pos[2], colpoint2.pos[3])
                        if doesObjectExist(map.CURSOR_POINTER) then
                            setObjectCoordinates(map.CURSOR_POINTER, pos.x, pos.y, pos.z + 0.2)
                            if isCharTouchingObject(PLAYER_PED, map.CURSOR_POINTER) then
                                printStyledString('Touching', 50, 7)
                            end
                        end

                        if wasKeyPressed(VK_RBUTTON) then
                            local beat_target = false
                            if doesObjectExist(map.CURSOR_POINTER) then
                                local cursor_result, cursorX, cursorY, cursorZ = getObjectCoordinates(map.CURSOR_POINTER)
                                for handle, tag in pairs(map.pool.bots) do
                                    if handle ~= PLAYER_PED then
                                        local x, y, z = getCharCoordinates(handle)
                                        if getDistanceBetweenCoords3d(cursorX, cursorY, cursorZ, x, y, z) < 1 then
                                            movement.target_handle = handle
                                            beat_target = true
                                            sampAddChatMessage('gotoped', -1)
                                            break
                                        end
                                    end
                                end
                            end
                            if not beat_target then
                                movement.target_handle = nil
                            end
                            

                            movement.go_to_coords = true
                            movement.go_to_coords_coords = pos
                            table.insert(movement.circles, {
                                pos = pos,
                                start = os.clock(),
                                radius = 0.5,
                                alpha = 255
                            })
                        end
                    end
                end
                

                ---->> draw movement circles
                for index, data in ipairs(movement.circles) do
                    if data.radius < 1 then
                        map.drawCircleIn3d(data.pos.x, data.pos.y, data.pos.z, data.radius, join_argb(data.alpha, 0, 255, 0), 2, 100) 
                        local sx, sy = convert3DCoordsToScreen(data.pos.x, data.pos.y, data.pos.z)
                        local sy = sy - 15 + data.radius * 10
                        renderDrawBox(sx - 2, sy - 10, 4, 10, join_argb(data.alpha, 0, 255, 0))
                        renderDrawPolygon(sx, sy, 10, 10, 3, 180, join_argb(data.alpha, 0, 255, 0))
                        movement.circles[index].radius = bringFloatTo(data.radius, 1, data.start, 0.7)
                        movement.circles[index].alpha = bringFloatTo(data.alpha, 0, data.start, 0.7)
                    end
                end

                if movement.go_to_coords then
                    local ped = Vector3D(getCharCoordinates(PLAYER_PED))
                    local go_to = Vector3D(movement.go_to_coords_coords.x,  movement.go_to_coords_coords.y,  movement.go_to_coords_coords.z)
                    
                    if movement.target_handle and movement.target_handle ~= PLAYER_PED then
                        if doesCharExist(movement.target_handle) then
                            go_to = Vector3D(getCharCoordinates(movement.target_handle))
                        else
                            movement.target_handle = nil
                        end
                    end
                    taskCharSlideToCoord(PLAYER_PED, go_to.x, go_to.y, go_to.z, getCharHeading(PLAYER_PED), 1)
                    --taskCharSlideToCoordAndPlayAnim(PLAYER_PED, go_to.x, go_to.y, go_to.z, 0, 1, PLAYER.hero.hit_animation.name, PLAYER.hero.hit_animation.file, 100, false, false, false, false, false)
                            
                    setGameKeyState(16, 256)
                    if getDistanceBetweenCoords3d(ped.x, ped.y, ped.z, go_to.x,  go_to.y,  go_to.z) <= 1.5 then
                        if movement.target_handle then
                        --    local target = Vector3D(getCharCoordinates(movement.target_handle))
                        --    local player = Vector3D(getCharCoordinates(PLAYER_PED))
                        --    if getDistanceBetweenCoords3d(target.x, target.y, target.z, player.x, player.y, player.z) > 1 then
                        --       -- taskCharSlideToCoord(PLAYER_PED, target.x, target.y, target.z, getCharHeading(PLAYER_PED), 1)
                        --    else
                        --        --clearCharTasksImmediately(PLAYER_PED)     
                        --    end
                               
                        else
                            movement.go_to_coords = false
                        end

                    end
                end

                if wasKeyPressed(49) then
                    setGameKeyState(17, 256)
                end

                -- fight with enemy
                if movement.target_handle and movement.target_handle ~= PLAYER_PED then
                    if doesCharExist(movement.target_handle) then


                        local target = Vector3D(getCharCoordinates(movement.target_handle))
                        local player = Vector3D(getCharCoordinates(PLAYER_PED))
                        if getDistanceBetweenCoords3d(target.x, target.y, target.z, player.x, player.y, player.z) <= PLAYER.hero.hit_distance then
                            local fire_rate = 1
                            if movement.last_hit + PLAYER.hero.hit_speed - os.clock() <= 0 then
                                movement.last_hit = os.clock()

                                clearCharTasksImmediately(PLAYER_PED)
                                taskPlayAnim(PLAYER_PED, PLAYER.hero.hit_animation.name, PLAYER.hero.hit_animation.file, 1000, false, false, false, false, -1)
                                map.set_hp(movement.target_handle, getCharHealth(movement.target_handle) - PLAYER.hero.damage) -- 20 - damage
                                if getCharHealth(movement.target_handle) <= 0 then
                                    map.pool.bots[movement.target_handle] = nil
                                    deleteChar(movement.target_handle)
                                    movement.target_handle = nil
                                    movement.go_to_coords = false
                                    clearCharTasksImmediately(PLAYER_PED)
                                end
                                
                                sampAddChatMessage('HIT', -1)
                            end
                        end
                        local sx, sy = convert3DCoordsToScreen(target.x, target.y, target.z)
                        renderDrawPolygon(sx, sy, 20, 20, 10, 0, 0xFFff0000)
                    end
                end
            end
        end
    end
end





function join_argb(a, r, g, b)
    local argb = b  -- b
    argb = bit.bor(argb, bit.lshift(g, 8))  -- g
    argb = bit.bor(argb, bit.lshift(r, 16)) -- r
    argb = bit.bor(argb, bit.lshift(a, 24)) -- a
    return argb
end

function bringFloatTo(from, to, start_time, duration)
    local timer = os.clock() - start_time
    if timer >= 0.00 and timer <= duration then
        local count = timer / (duration / 100)
        return from + (count * (to - from) / 100), true
    end
    return (timer > duration) and to or from, false
end

function imgui.CenterText(text)
    imgui.SetCursorPosX(imgui.GetWindowSize().x / 2 - imgui.CalcTextSize(text).x / 2)
    imgui.Text(text)
end