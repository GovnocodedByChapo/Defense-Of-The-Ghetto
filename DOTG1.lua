--[[
                                                                                                                                         
                                                                                                                                         
DDDDDDDDDDDDD             OOOOOOOOO     TTTTTTTTTTTTTTTTTTTTTTT       GGGGGGGGGGGGG  1111111                                             
D::::::::::::DDD        OO:::::::::OO   T:::::::::::::::::::::T    GGG::::::::::::G 1::::::1                                             
D:::::::::::::::DD    OO:::::::::::::OO T:::::::::::::::::::::T  GG:::::::::::::::G1:::::::1                                             
DDD:::::DDDDD:::::D  O:::::::OOO:::::::OT:::::TT:::::::TT:::::T G:::::GGGGGGGG::::G111:::::1                                             
  D:::::D    D:::::D O::::::O   O::::::OTTTTTT  T:::::T  TTTTTTG:::::G       GGGGGG   1::::1                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G                 1::::1                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G                 1::::1                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G    GGGGGGGGGG   1::::l                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G    G::::::::G   1::::l                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G    GGGGG::::G   1::::l                                             
  D:::::D     D:::::DO:::::O     O:::::O        T:::::T       G:::::G        G::::G   1::::l                                             
  D:::::D    D:::::D O::::::O   O::::::O        T:::::T        G:::::G       G::::G   1::::l                                             
DDD:::::DDDDD:::::D  O:::::::OOO:::::::O      TT:::::::TT       G:::::GGGGGGGG::::G111::::::111                                          
D:::::::::::::::DD    OO:::::::::::::OO       T:::::::::T        GG:::::::::::::::G1::::::::::1                                          
D::::::::::::DDD        OO:::::::::OO         T:::::::::T          GGG::::::GGG:::G1::::::::::1                                          
DDDDDDDDDDDDD             OOOOOOOOO           TTTTTTTTTTT             GGGGGG   GGGG111111111111                                          
                                                                                                                                         
                                                                                                                                                                                                                                                                                
                                                                                                                                         
DDDDDDDDDDDDD                               ffffffffffffffff                                                                             
D::::::::::::DDD                           f::::::::::::::::f                                                                            
D:::::::::::::::DD                        f::::::::::::::::::f                                                                           
DDD:::::DDDDD:::::D                       f::::::fffffff:::::f                                                                           
  D:::::D    D:::::D     eeeeeeeeeeee     f:::::f       ffffffeeeeeeeeeeee    nnnn  nnnnnnnn        ssssssssss       eeeeeeeeeeee        
  D:::::D     D:::::D  ee::::::::::::ee   f:::::f           ee::::::::::::ee  n:::nn::::::::nn    ss::::::::::s    ee::::::::::::ee      
  D:::::D     D:::::D e::::::eeeee:::::eef:::::::ffffff    e::::::eeeee:::::een::::::::::::::nn ss:::::::::::::s  e::::::eeeee:::::ee    
  D:::::D     D:::::De::::::e     e:::::ef::::::::::::f   e::::::e     e:::::enn:::::::::::::::ns::::::ssss:::::se::::::e     e:::::e    
  D:::::D     D:::::De:::::::eeeee::::::ef::::::::::::f   e:::::::eeeee::::::e  n:::::nnnn:::::n s:::::s  ssssss e:::::::eeeee::::::e    
  D:::::D     D:::::De:::::::::::::::::e f:::::::ffffff   e:::::::::::::::::e   n::::n    n::::n   s::::::s      e:::::::::::::::::e     
  D:::::D     D:::::De::::::eeeeeeeeeee   f:::::f         e::::::eeeeeeeeeee    n::::n    n::::n      s::::::s   e::::::eeeeeeeeeee      
  D:::::D    D:::::D e:::::::e            f:::::f         e:::::::e             n::::n    n::::nssssss   s:::::s e:::::::e               
DDD:::::DDDDD:::::D  e::::::::e          f:::::::f        e::::::::e            n::::n    n::::ns:::::ssss::::::se::::::::e              
D:::::::::::::::DD    e::::::::eeeeeeee  f:::::::f         e::::::::eeeeeeee    n::::n    n::::ns::::::::::::::s  e::::::::eeeeeeee      
D::::::::::::DDD       ee:::::::::::::e  f:::::::f          ee:::::::::::::e    n::::n    n::::n s:::::::::::ss    ee:::::::::::::e      
DDDDDDDDDDDDD            eeeeeeeeeeeeee  fffffffff            eeeeeeeeeeeeee    nnnnnn    nnnnnn  sssssssssss        eeeeeeeeeeeeee                                                                                                                                  
                                                                                                                                         
                                                                                                                                         
     OOOOOOOOO        ffffffffffffffff       TTTTTTTTTTTTTTTTTTTTTTThhhhhhh                                                              
   OO:::::::::OO     f::::::::::::::::f      T:::::::::::::::::::::Th:::::h                                                              
 OO:::::::::::::OO  f::::::::::::::::::f     T:::::::::::::::::::::Th:::::h                                                              
O:::::::OOO:::::::O f::::::fffffff:::::f     T:::::TT:::::::TT:::::Th:::::h                                                              
O::::::O   O::::::O f:::::f       ffffff     TTTTTT  T:::::T  TTTTTT h::::h hhhhh           eeeeeeeeeeee                                 
O:::::O     O:::::O f:::::f                          T:::::T         h::::hh:::::hhh      ee::::::::::::ee                               
O:::::O     O:::::Of:::::::ffffff                    T:::::T         h::::::::::::::hh   e::::::eeeee:::::ee                             
O:::::O     O:::::Of::::::::::::f                    T:::::T         h:::::::hhh::::::h e::::::e     e:::::e                             
O:::::O     O:::::Of::::::::::::f                    T:::::T         h::::::h   h::::::he:::::::eeeee::::::e                             
O:::::O     O:::::Of:::::::ffffff                    T:::::T         h:::::h     h:::::he:::::::::::::::::e                              
O:::::O     O:::::O f:::::f                          T:::::T         h:::::h     h:::::he::::::eeeeeeeeeee                               
O::::::O   O::::::O f:::::f                          T:::::T         h:::::h     h:::::he:::::::e                                        
O:::::::OOO:::::::Of:::::::f                       TT:::::::TT       h:::::h     h:::::he::::::::e                                       
 OO:::::::::::::OO f:::::::f                       T:::::::::T       h:::::h     h:::::h e::::::::eeeeeeee                               
   OO:::::::::OO   f:::::::f                       T:::::::::T       h:::::h     h:::::h  ee:::::::::::::e                               
     OOOOOOOOO     fffffffff                       TTTTTTTTTTT       hhhhhhh     hhhhhhh    eeeeeeeeeeeeee                               
                                                                                                                                         
                                                                                                                                                                                                                                                                        
        GGGGGGGGGGGGGhhhhhhh                                          tttt               tttt                                  1111111   
     GGG::::::::::::Gh:::::h                                       ttt:::t            ttt:::t                                 1::::::1   
   GG:::::::::::::::Gh:::::h                                       t:::::t            t:::::t                                1:::::::1   
  G:::::GGGGGGGG::::Gh:::::h                                       t:::::t            t:::::t                                111:::::1   
 G:::::G       GGGGGG h::::h hhhhh           eeeeeeeeeeee    ttttttt:::::tttttttttttttt:::::ttttttt       ooooooooooo           1::::1   
G:::::G               h::::hh:::::hhh      ee::::::::::::ee  t:::::::::::::::::tt:::::::::::::::::t     oo:::::::::::oo         1::::1   
G:::::G               h::::::::::::::hh   e::::::eeeee:::::eet:::::::::::::::::tt:::::::::::::::::t    o:::::::::::::::o        1::::1   
G:::::G    GGGGGGGGGG h:::::::hhh::::::h e::::::e     e:::::etttttt:::::::tttttttttttt:::::::tttttt    o:::::ooooo:::::o        1::::l   
G:::::G    G::::::::G h::::::h   h::::::he:::::::eeeee::::::e      t:::::t            t:::::t          o::::o     o::::o        1::::l   
G:::::G    GGGGG::::G h:::::h     h:::::he:::::::::::::::::e       t:::::t            t:::::t          o::::o     o::::o        1::::l   
G:::::G        G::::G h:::::h     h:::::he::::::eeeeeeeeeee        t:::::t            t:::::t          o::::o     o::::o        1::::l   
 G:::::G       G::::G h:::::h     h:::::he:::::::e                 t:::::t    tttttt  t:::::t    tttttto::::o     o::::o        1::::l   
  G:::::GGGGGGGG::::G h:::::h     h:::::he::::::::e                t::::::tttt:::::t  t::::::tttt:::::to:::::ooooo:::::o     111::::::111
   GG:::::::::::::::G h:::::h     h:::::h e::::::::eeeeeeee        tt::::::::::::::t  tt::::::::::::::to:::::::::::::::o     1::::::::::1
     GGG::::::GGG:::G h:::::h     h:::::h  ee:::::::::::::e          tt:::::::::::tt    tt:::::::::::tt oo:::::::::::oo      1::::::::::1
        GGGGGG   GGGG hhhhhhh     hhhhhhh    eeeeeeeeeeeeee            ttttttttttt        ttttttttttt     ooooooooooo        111111111111


    
        __                  __                    
       / /_  __  __   _____/ /_  ____ _____  ____ 
      / __ \/ / / /  / ___/ __ \/ __ `/ __ \/ __ \
     / /_/ / /_/ /  / /__/ / / / /_/ / /_/ / /_/ /
    /_.___/\__, /   \___/_/ /_/\__,_/ .___/\____/ 
          /____/                   /_/            

]]                                                                                                                                         
                                                                                                                                         
                                                                                                                                         
script_name('DOTG1 - Defence Of The Ghetto 1 (by chapo // vk.com/chaposcripts)')                                                                                                                               
script_author('chapo')                                                            
script_version('1')                                                                                                                     

require('lib.moonloader')
local ffi = require('ffi')
_require = require
require = function(module, URL)
    local status, result = pcall(_require, module)
    if not status then
        ffi.cdef([[int MessageBoxA(void* hWnd, const char* lpText, const char* lpCaption, unsigned int uType);]])
        local btn = ffi.C.MessageBoxA(ffi.cast('void*', readMemory(0x00C8CF88, 4, false)), ('Ошибка, модуль "%s" не найден!\n\n%s\n\n'..(URL and '\nОткрыть страницу загрузки?' or '')):format(module, result), thisScript().name..' - error', URL and 0x4 or 0x0)
        if URL and btn == 6 then os.execute(('explorer "%s"'):format(URL)) end
        assert(status, result)
    end
    return result
end

local imgui = require('mimgui')
local Vector3D = require('vector3d')
--local core = require('DOTG1.core')
local map = require('DOTG1.map')
local camera = require('DOTG1.camera')
local local_player = require('DOTG1.local_player')
local hero = require('DOTG1.hero')
local resource = require('DOTG1.resource')
local ui = require('DOTG1.ui')
local items = require('DOTG1.items')
local ai = require('DOTG1.ai')
local movement = require('DOTG1.movement')

SIDE_GROOVE, SIDE_BALLAS, GAME_STATE = 0, 1, { NONE = 0, MAIN_MENU = 1, HERO_SELECT = 2, IN_GAME = 3, IN_GAME_PAUSED = 4 }
--PLAYER = local_player.PLAYER

--==[ INTERFACE ]==--
imgui.OnInitialize(function()
    imgui.GetIO().IniFilename = nil
    ui.init()
end)

local selection_pos = imgui.ImVec2(0, 0)
pedGoTo = taskCharSlideToCoord
taskCharSlideToCoord = function(...)
    local status, result = pcall(pedGoTo, ...)
    if status then
        print('[PEDGOTO] ALLOK: '..table.concat({...}, ', '))
    else
        print('[PEDGOTO] FATAL: '..table.concat({...}, ', '), result)
    end
end
local ui_frame = imgui.OnFrame(
    function() 
        return local_player.PLAYER.STATE ~= GAME_STATE.NONE
    end,
    function(self)
        self.HideCursor = local_player.PLAYER.STATE ~= GAME_STATE.MAIN_MENU and local_player.PLAYER.STATE ~= GAME_STATE.HERO_SELECT
        local BGDL = imgui.GetBackgroundDrawList()
        if isKeyDown(VK_LBUTTON) then
            BGDL:AddRectFilled(selection_pos, imgui.ImVec2(getCursorPos()), imgui.GetColorU32Vec4(imgui.ImVec4(0, 0.84, 0.18, 0.4)))
            BGDL:AddRect(selection_pos, imgui.ImVec2(getCursorPos()), imgui.GetColorU32Vec4(imgui.ImVec4(0, 0.84, 0.18, 0.4)), 0, 0, 3)
        end

        -->> Main menu
        if local_player.PLAYER.STATE == GAME_STATE.MAIN_MENU or local_player.PLAYER.STATE == GAME_STATE.HERO_SELECT then
            ui.draw_main_menu(function(index)
                local_player.PLAYER.hero_index = index
                local_player.PLAYER.hero = hero.list[index]
                local_player.PLAYER.STATE = GAME_STATE.IN_GAME   
                local_player.max_health = local_player.PLAYER.hero.max_health
                local_player.max_mana = local_player.PLAYER.hero.max_mana
                local_player.health = local_player.PLAYER.hero.max_health
                local_player.mana = local_player.PLAYER.hero.max_mana
                setPlayerModel(Player, local_player.PLAYER.hero.model)
                --map.create_map()
                map.set_hp(PLAYER_PED, local_player.max_health)
                setCharCoordinates(PLAYER_PED, 154, 5, 601)
                giveWeaponToChar(PLAYER_PED, local_player.PLAYER.hero.weapon, local_player.PLAYER.hero.weapon_ammo)
                setCurrentCharWeapon(PLAYER_PED, local_player.PLAYER.hero.weapon)
                camera.point_camera_to_player()
                map.load_map(local_player.PLAYER.selected_map, local_player.PLAYER.team)
            end)
        end

        -->> HUD
        if local_player.PLAYER.STATE == GAME_STATE.IN_GAME then
            ui.draw_game_hud()
            ui.draw_health_bars(imgui.GetBackgroundDrawList())
            ui.draw_shop_button()
            if items.shop_menu then ui.draw_shop_menu() end
        end

        -->> Pause menu
        if local_player.PLAYER.STATE == GAME_STATE.IN_GAME_PAUSED then
            ui.draw_pause()
        end
    end
)



-->> Event Handlers
addEventHandler('onScriptTerminate', function(scr, quit)
    if scr == thisScript() then
        map.destroy_map()
        if not quit then
            --core.log('[FATAR ERROR] Script crashed (quit = false)')
            thisScript():reload()
        end
    end
end)

addEventHandler('onWindowMessage', function(msg, key)
    if local_player.PLAYER.STATE == GAME_STATE.IN_GAME and msg == 0x0100 and not sampIsChatInputActive() then
        local binds = {
            [VK_Q] = function() local_player.use_ability(local_player.PLAYER.hero.abilities[1], 1) end,
            [VK_W] = function() local_player.use_ability(local_player.PLAYER.hero.abilities[2], 2) end,
            [VK_E] = function() local_player.use_ability(local_player.PLAYER.hero.abilities[3], 3) end,
            [VK_R] = function() local_player.use_ability(local_player.PLAYER.hero.abilities[4], 4) end,
            
            [VK_Z] = function() items.use_item(local_player.items[1], 1, false) end,
            [VK_X] = function() items.use_item(local_player.items[2], 2, false) end,
            [VK_C] = function() items.use_item(local_player.items[3], 3, false) end,
        }

        for bind_key, callback in pairs(binds) do
            if key == bind_key then
                callback() 
            end
        end
    end
end)

-->> Inits and loops
function main()
    while not isSampAvailable() do wait(0) end
    sampRegisterChatCommand('dota', function()
        local_player.PLAYER.STATE = GAME_STATE.MAIN_MENU
        camera.point_camera_to_player()
    end)
    sampRegisterChatCommand('map', function()
        lua_thread.create(function()
            map.create_map()
            --map.teleport_player_to_map()
            setCharCoordinates(PLAYER_PED, 154, 5, 601)
            wait(500)
            PLAYER.STATE = GAME_STATE.IN_GAME
            map.set_hp(PLAYER_PED, local_player.max_health)
            giveWeaponToChar(PLAYER_PED, 8, 1)
            setCurrentCharWeapon(PLAYER_PED, 8)
        end)
    end)

    sampRegisterChatCommand('dotg.loadmap', function(arg)
        if doesFileExist(getWorkingDirectory()..'\\lib\\DOTG1\\maps\\'..arg) then
            local F = io.open(getWorkingDirectory()..'\\lib\\DOTG1\\maps\\'..arg, 'r')
            local json = F:read('*all')
            F:close()
            map.load_map(json, SIDE_GROOVE)
        else
            sampAddChatMessage('map not found!', -1)
        end
    end)

    sampRegisterChatCommand('spawncreeps', function()
        map.spawn_creep_stack(SIDE_GROOVE, 3)
    end)
    
    -->> INIT DOTG1
    --core.log('Initializing modules...')
    map.init()
    camera.init()
    ai.tower_loop()
    --core.log('Tower loop started')
    --movement.setup_key_hook() --// empty function (moved to DOTG1.lua -> addEventHandler -> onWindowMessage)
    while true do
        wait(0)
        if local_player.PLAYER.STATE == GAME_STATE.IN_GAME then
            if wasKeyPressed(VK_LBUTTON) then
                selection_pos = imgui.ImVec2(getCursorPos())
            end
            local curX, curY = getCursorPos()
            local resX, resY = getScreenResolution()
            showCursor(not isKeyDown(VK_MBUTTON))
            local_player.loop()
            if local_player.PLAYER.camera_mode == 0 then camera.update_camera() end
            if isKeyDown(VK_LMENU) then map.draw_building_circles() end
            map.set_hp(PLAYER_PED, local_player.health)
            map.draw_circle_on_target()
            map.bots_ai()
            movement.loop()
            movement.fight_loop()
            movement.disable_game_keys() 
            movement.draw_circles()



            -->> DEBUG
            if doesObjectExist(map.CURSOR_POINTER) then
                local pos = movement.get_pointer_pos()
                setObjectCoordinates(map.CURSOR_POINTER, pos.x, pos.y, pos.z + 0.2)
            end

            -->> PED highlight
            do
                for handle, tag in pairs(map.pool.bots) do
                    local x, y, z = getCharCoordinates(handle)
                    if map.get_distance_from_pointer(x, y, z) < 1 then
                        drawShadow(3, x, y, z + 1, 0.0, 1, 1, 1, 0, 0) 
                        drawLightWithRange(x, y, z + 2, 255, 0, 0, 10)  -- 09E5
                    end
                end
            end
        end
    end
end


-- wtf? todo: move this shit to lib\DOTG1\ui.lua
function join_argb(a, r, g, b)
    local argb = b  -- b
    argb = bit.bor(argb, bit.lshift(g, 8))  -- g
    argb = bit.bor(argb, bit.lshift(r, 16)) -- r
    argb = bit.bor(argb, bit.lshift(a, 24)) -- a
    return argb
end

function bringFloatTo(from, to, start_time, duration)
    local timer = os.clock() - start_time
    if timer >= 0.00 and timer <= duration then
        local count = timer / (duration / 100)
        return from + (count * (to - from) / 100), true
    end
    return (timer > duration) and to or from, false
end